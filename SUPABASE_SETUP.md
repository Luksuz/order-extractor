# Supabase Setup Guide

## Environment Variables

Create a `.env.local` file in the root directory with the following variables:

```bash
# Supabase Configuration
NEXT_PUBLIC_SUPABASE_URL=your_supabase_project_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key

# RxOffice EDI SOAP Configuration
RXOFFICE_WSDL_URL=http://127.0.0.1:5000/Services/CommonEDIService.svc?wsdl
RXOFFICE_USERNAME=380
RXOFFICE_PASSWORD=ZOHO123

# Enable real SOAP service (set to 'true' when RxOffice service is ready)
USE_REAL_SOAP_SERVICE=false
```

## Testing Modes

### Mock Mode (Default)
- **VCA logging**: All form data is converted to VCA format and logged to console
- **Mock responses**: Returns fake order numbers and success messages
- **No external dependencies**: Works without RxOffice service running
- **Perfect for development**: Test the entire flow without backend setup

### Real SOAP Mode
Set `USE_REAL_SOAP_SERVICE=true` to enable actual SOAP calls to RxOffice EDI service.

## Example Configuration

```bash
# Supabase - Replace with your actual Supabase project values
NEXT_PUBLIC_SUPABASE_URL=https://your-project-ref.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# RxOffice EDI - Replace with your actual service endpoint and credentials
RXOFFICE_WSDL_URL=https://your-rxoffice-server.com/Services/CommonEDIService.svc?wsdl
RXOFFICE_USERNAME=your_username
RXOFFICE_PASSWORD=your_password

# Use real service when ready
USE_REAL_SOAP_SERVICE=true
```

## Customer Table Schema

The customer table should match this schema:

```sql
create table public.customer (
  id bigint generated by default as identity not null,
  created_at timestamp with time zone not null default now(),
  code text null,
  name text null,
  address1 text null,
  address2 text null,
  zip_postal_code text null,
  city text null,
  description text null,
  constraint customer_pkey primary key (id)
) TABLESPACE pg_default;
```

## RxOffice EDI Integration

### SOAP Service Features

- **CreateOrder**: Submit prescription orders using VCA format
- **Customer Matching**: Automatic customer code lookup and replacement
- **VCA Format**: Converts form data to Vision Council of America standard
- **Error Handling**: Comprehensive error reporting and validation
- **Mock Mode**: Test without real service for development

### VCA Format Example

The system converts your form data to VCA format like this:
```
DO=B;JOB=ORD123456;CLIENT=CUST001;SPH=-1.75;-1.75;CYL=-0.5;-0.25;AX=45;180;ADD=1.75;1.75;IPD=30.5;30.5
```

### Console Output Example
When you submit an order, you'll see detailed logging:
```
================================================================================
ðŸ“‹ ORDER SUBMISSION TO RXOFFICE EDI
================================================================================
ðŸ”¹ Generated VCA String:
DO=B;JOB=ORD123456;CLIENT=CUST001;SPH=-1.75;-1.75;CYL=-0.5;-0.25

ðŸ”¹ VCA Fields Breakdown:
   DO: B
   JOB: ORD123456
   CLIENT: CUST001
   SPH: -1.75;-1.75
   CYL: -0.5;-0.25
================================================================================
ðŸ”¹ Credentials: 380 / *******
ðŸ”¹ Using mock response (real SOAP service disabled)
ðŸ”¹ Mock order created: ORD-12345678
================================================================================
```

### Testing the SOAP Connection

1. Test the connection: `GET /api/create-order-soap`
2. This will return available SOAP methods and connection status (or mock mode info)

## Quick Start Testing

### 1. Test Immediately (No Setup Required)
```bash
npm run dev
# Navigate to http://localhost:3000
# Upload an image and submit - see VCA logging in console
```

### 2. Test Customer Matching (Optional)
- Set up Supabase with customer data
- See real-time customer name â†’ code replacement

### 3. Test Real SOAP Service (When Ready)
- Deploy your RxOffice EDI service
- Set `USE_REAL_SOAP_SERVICE=true`
- Configure real WSDL URL and credentials

## How to Get Supabase Credentials

1. Go to [https://supabase.com](https://supabase.com)
2. Create a new project or select an existing one
3. Go to Settings > API
4. Copy the Project URL and anon/public key
5. Add them to your `.env.local` file

## Testing the Integration

After setting up the environment variables:

1. Restart your development server: `npm run dev`
2. Test the customer matching API: `GET /api/match-customer`
3. Test the SOAP connection: `GET /api/create-order-soap`
4. Try entering customer names in the form to see real-time matching
5. Submit a complete order to test the full SOAP integration
6. **Check browser console** for detailed VCA logging

## Troubleshooting

### SOAP Connection Issues
- Verify the WSDL URL is accessible
- Check firewall settings for the RxOffice server
- Ensure credentials are correct
- **Try mock mode first** (`USE_REAL_SOAP_SERVICE=false`)

### Customer Matching Issues
- Verify Supabase connection
- Check customer table exists and has data
- Review customer name format in database
- **Falls back to mock data** if Supabase unavailable

### VCA Format Issues
- Ensure required fields (JOB, CLIENT) are filled
- Check prescription data uses R;L format (e.g., "-1.75;-1.75")
- **Review VCA string in browser console** for debugging
- All VCA data is logged regardless of mock/real mode

### Development Workflow
1. **Start with mock mode** - test VCA generation and UI flow
2. **Add Supabase** - test customer matching
3. **Deploy RxOffice service** - enable real SOAP mode
4. **Go live** - full production setup 